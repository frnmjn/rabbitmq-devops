version: '3.9'

services:
  rabbitmq:
    container_name: "rabbitmq"
    image: rabbitmq:3.10-management
    restart: unless-stopped
    hostname: rabbitmq
    ports:
      - 15692:15692
      - 15672:15672
      - 5672:5672
    volumes:
      - type: bind
        source: ./enabled_plugins
        target: /etc/rabbitmq/enabled_plugins
    environment:
      RABBITMQ_DEFAULT_USER: rabbit
      RABBITMQ_DEFAULT_PASS: rabbit

  rabbitmq-perftest:
    container_name: "rabbitmq-perftest"
    image: pivotalrabbitmq/perf-test
    restart: unless-stopped
    environment:
      URI: "amqp://rabbit:rabbit@host.docker.internal:5672/%2f"
      QUEUE: test
      ROUTING_KEY: test
      AUTOACK: "true"
      SERVERS_STARTUP_TIMEOUT: 15
    extra_hosts:
      - host.docker.internal:host-gateway
    depends_on:
      - rabbitmq
  
  grafana:
    container_name: "grafana"
    image: grafana/grafana:latest
    restart: unless-stopped
    volumes:
      - ./grafana:/var/lib/grafana
    user: root
    environment:
      - GF_SMTP_ENABLED=true
      - GF_SMTP_HOST=smtp4dev:25
    ports:
      - 3000:3000

  prometheus:
    container_name: "prometheus"
    image: prom/prometheus:latest
    restart: unless-stopped
    volumes:
      - type: bind
        source: ./prometheus.yml
        target: /etc/prometheus/prometheus.yml
    user: root
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    ports:
      - 9090:9090
      
  smtp4dev:
    container_name: "smtp4dev"
    image: rnwood/smtp4dev:v3
    restart: unless-stopped
    ports:
      - 2525:2525
      - 1080:80
